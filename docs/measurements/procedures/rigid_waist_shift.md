# IR LHC Local Coupling Corrections With a Rigid Waist Shift

!!! note ""
    Please keep in mind the [general checks](general_checks.md) for measurements.

??? info "The Procedure in Short"

      This methods aims to find the MQSX correction settings that would minimize betatron coupling and its impact on beam size *at the IP*.
      The method breaks the symmetry of the optics in the IR and forces local coupling RDTs to leak throughout the machine, which makes them measurable through the $|C^{-}|$.


      After global corrections are done and trimmed in the machine, one applies a rigid waist shift in a given IR and scans the colinearity knob for the value that minimizes the $|C^{-}|$.
      These settings, when taking away the rigid waist shift, will minimize local coupling and its impact at the IP.

## Rigid Waist Shift & LSA Knobs

Some information about the rigid waist shift can be found in [this gallery page][rws_gallery] from Felix's package's documentation.
Some details about the creation of these knobs and their addition in LSA can be found in this [LHC OMC logbook entry](https://be-op-logbook.web.cern.ch/elogbook-server/GET/showEventInLogbook/3545713){target=_blank} and the ones that follow.

### Knob Setting Convention

Since the waist can be shifted in two directions - left and right of the IP - two knobs were generated per IP, for a unit setting of $1$ and -$1$.
This unit setting is an arbitrary definition, where a value of $1$ corresponds to a $0.5$% change of the triplet powering.
This, in turn, corresponds to  a waist shift of ~43-44cm in a given direction.

The knob setting is defined as follows, with regards to Beam1 (reverse for Beam2):

- Unit setting of +$1$: shifts the waist to the _left_ of the IP ($s_{waist}^{B1} < s_{IP}^{B1}$)
- Unit setting of -$1$: shifts the waist to the _right_ of the IP ($s_{waist}^{B1} > s_{IP}^{B1}$)

It is possible to generate knobs for different unit settings but for LHC operation these values are the ones that were used by Felix S.

### The Knobs in LSA

There are two different types of knobs that need to be trimmed in:

- A knob for the triplet quadrupoles
- A knob for the independent quadrupoles used to rematch the optics.

A knob for the MQTs could be used to rematch the working point, but in operation the tune feedback should take care of this.
Since the triplet knob for a unit setting of +$1$ is the opposite sign of the knob for a unit setting of -$1$, only a single triplet knob per IP has been added to LSA, which can then be trimmed with a factor of Â±$1$.

As a consequence, respect the following rules:

 - When trimming the triplet knob with a factor of +$1$, use the *pos* independent quadrupoles knob
 - When trimming the triplet knob with a factor of -$1$, use the *neg* independent quadrupoles knob

Here are the LSA knobs for the triplets:
<!-- Triplet knobs table -->
|  IP   |                        Knob Name                         |
| :---: | :------------------------------------------------------: |
|  IP1  | LHCBEAM/MD_ATS_2020-05_04_BX_RigidWaistShift_Triplet_IP1 |
|  IP5  | LHCBEAM/MD_ATS_2020-05_04_BX_RigidWaistShift_Triplet_IP5 |
<!-- Triplet knobs table -->

Here are the LSA knobs for the independent quadrupoles:
<!-- Quadrupoles knobs table -->
|  Beam  |  IP   |                      Knob Name                      |
| :----: | :---: | :-------------------------------------------------: |
| Beam 1 |  IP1  | LHCBEAM/MD_ATS_2022_05_04_B1_RigidWaitsShift_IP1neg |
|        |       | LHCBEAM/MD_ATS_2022_05_04_B2_RigidWaitsShift_IP1pos |
|        |  IP5  | LHCBEAM/MD_ATS_2022_05_04_B1_RigidWaitsShift_IP5neg |
|        |       | LHCBEAM/MD_ATS_2022_05_04_B1_RigidWaitsShift_IP5pos |
| Beam 2 |  IP1  | LHCBEAM/MD_ATS_2022_05_04_B2_RigidWaitsShift_IP1neg |
|        |       | LHCBEAM/MD_ATS_2022_05_04_B2_RigidWaitsShift_IP1pos |
|        |  IP5  | LHCBEAM/MD_ATS_2022_05_04_B2_RigidWaitsShift_IP5neg |
|        |       | LHCBEAM/MD_ATS_2022_05_04_B2_RigidWaitsShift_IP5pos |
<!-- Quadrupoles knobs table -->

!!! warning "Value of the Waist Shift"
      The waist shift from the generated knobs should be of about 43 to 44cm in either direction.
      In operation in the machine, it is likely that the optics aren't perfect and already present a small waist shift, which would add on top of the one generated by these knobs.
      This means one should expect the waists left and right to be slightly un-symmetric.

## Preliminary Setup

- [ ] <details class="nodeco"><summary>Do Global Corrections</summary>
      <p> This procedure needs global corrections to be trimmed in the machine first, so optics and *global coupling* should be taken care of beforehand.
      </p></details>

- [ ] <details class="nodeco"><summary>**Optional:** Scan the Colinearity Knob to Check Conditions</summary>
      <p> If time allows, ideally we would scan the colinearity knob to ensure we see very small variations of the $|C^{-}|$.
      If strong variations are noticed, then the expected conditions for the procedure are not met: either the phase advance between left and right MQSXs is off, or the $\sqrt{\beta_x \beta_y}$ is significantly wrong at these elements.
      </p></details>

## Procedure Per IP

This procedure is applied at the main experimental insertions (IR1 and IR5) where local corrections need to be established or checked.
Keep in mind that this does Beam1 and Beam2 at the same time, but different IPs cannot / should not be done in parallel.

!!! warning "Orbit Feedback"
      Please remember to **always** keep the orbit feedback system **ON** during this procedure if crossing angles are present in the machine.

- [ ] <details class="nodeco"><summary>Trim in the Waist Shift Knob</summary>
      <p> Trim the prepared knob in the machine, for a certain direction (waist left/right of the IP).
      Remember that this affects both beams at the same time.
      </p></details>

- [ ] <details class="nodeco"><summary>Scan the Colinearity Knob</summary>
      <p> Trim the colinearity knob, about half a unit at a time.
      For each setting, do some kicks and measure the $|C^{-}|$.
      </p></details>

- [ ] <details class="nodeco"><summary>Go Back to Nominal Machine</summary>
      <p> Trim out the rigid waist shift, and ensure that no drift from nominal is observed.
      If needed, do another round of global corrections.
      </p></details>

- [ ] <details class="nodeco"><summary>Trim in the Opposite Waist Shift Knob</summary>
      <p> Trim the prepared knob in the machine, for the other direction (waist right/left of the IP).
      </p></details>

- [ ] <details class="nodeco"><summary>Scan the Colinearity Knob</summary>
      <p> Trim the colinearity knob, about half a unit at a time.
      For each setting, do some kicks and measure the $|C^{-}|$.
      </p></details>

- [ ] <details class="nodeco"><summary>Determine the Correction</summary>
      <p> Plot the evolution of the $|C^{-}|$ against the setting of the colinearity knob, and pick the setting that minimizes it.
      The curves for each beam might not be minimized exactly around the same point, and a compromise may be needed.
      Eventually do a fit of the data to get a more accurate estimate of the correction.
      </p></details>

- [ ] <details class="nodeco"><summary>**Optional:** Perform a Luminosity Scan of the Colinearity Knob</summary>
      <p> In commissioning and if conditions allow, one can validate and fine tune the correction with a luminosity scan.
      This has to be performed without a rigid waist shift.
      </p></details>

- [ ] <details class="nodeco"><summary>**Optional:** Do Global Corrections After Trimming</summary>
      <p> One might want to do another round of global corrections, mainly coupling, after applying the determined colinearity knob setting.
      </p></details>


*[rigid waist shift]: Shifting the waist of the beam from the IP point by un-balancing the powering of the left and right triplets in the IR.
*[MQSX]: The skew quadrupole correctors localed next to Q3
*[LSA]: LHC Software Architecture
*[IP]: Interaction Point
*[IR]: Insertion Region
*[RDT]: Resonance Driving Terms
*[Colinearity Knob]: This is a powering setting of the MQSXs, which corresponds to a K1S value of +/- 1E-4 m^-2.

[rws_gallery]: https://fsoubelet.github.io/PyhDToolkit/gallery/demo_lhc_rigid_waist_shift.html