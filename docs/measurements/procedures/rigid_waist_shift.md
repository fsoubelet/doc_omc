# IR LHC Local Coupling Corrections With a Rigid Waist Shift

!!! note ""
    Please keep in mind the [general checks](general_checks.md) for measurements.

??? info "The Procedure in Short"

      This methods aims to find the MQSX correction settings that would minimize betatron coupling and its impact on beam size *at the IP*.
      The method breaks the symmetry of the optics in the IR and forces local coupling RDTs to leak throughout the machine, which makes them measurable through the $|C^{-}|$.


      After global corrections are done and trimmed in the machine, one applies a rigid waist shift in a given IR and scans the colinearity knob for the value that minimizes the $|C^{-}|$.
      These settings, when taking away the rigid waist shift, will minimize local coupling and its impact at the IP.
      Additional info can be found in Felix's 2021 IPAC paper[^SoubeletIPACLocalCouplingCorrection].

## Rigid Waist Shift & LSA Knobs

Some information about the rigid waist shift can be found in [this gallery page][rws_gallery]{target=_blank} from Felix's package's documentation.
Some details about the creation of these knobs and their addition in LSA can be found in this [LHC OMC logbook entry][logbook_entry]{target=_blank} and the ones that follow.

### Knob Setting Convention

Two different knobs are used for the waist shift that need to be trimmed in: 

- The triplets knob, which generates the waist shift itself.
- The independent quadrupoles knob (Q4 - Q10), which re-matches the optics.

The unit setting of the triplet knob is an arbitrary definition, where a value of $\pm1$ corresponds to a $\pm 0.5$% change of the triplet powering, which leads to a waist shift of ~43-44cm in a given direction.
The knob setting is defined as follows, with regards to Beam1 (reverse for Beam2):

- Unit setting of +$1$: shifts the waist to the _left_ of the IP ($s_{waist}^{B1} < s_{IP}^{B1}$)
- Unit setting of -$1$: shifts the waist to the _right_ of the IP ($s_{waist}^{B1} > s_{IP}^{B1}$)

### The Knobs in LSA

Since the triplet knob for a unit setting of +$1$ is the exact opposite magnet powering of the knob for a unit setting of -$1$, only a single triplet knob per IP has been added to LSA, which can then be trimmed with a factor of $\pm1$.
On the other hand, the re-matching quadrupole knobs are specific to a given direction of the shift, so two of them per IP (one per direction) were added to LSA, with the *pos* and *neg* suffixes.

As a consequence, respect the following rules when applying the knobs below:

 - When trimming the triplet knob with a factor of +$1$, use the *pos* re-matching quadrupoles knob.
 - When trimming the triplet knob with a factor of -$1$, use the *neg* re-matching quadrupoles knob.

??? example "LSA Triplets Knobs"

    |  IP   |                        Knob Name                         |
    | :---: | :------------------------------------------------------: |
    |  IP1  | LHCBEAM/MD_ATS_2020-05_04_BX_RigidWaistShift_Triplet_IP1 |
    |  IP5  | LHCBEAM/MD_ATS_2020-05_04_BX_RigidWaistShift_Triplet_IP5 |

??? example "LSA Independent Quadrupoles Knobs"

    |  Beam  |  IP   |                      Knob Name                      |
    | :----: | :---: | :-------------------------------------------------: |
    | Beam 1 |  IP1  | LHCBEAM/MD_ATS_2022_05_04_B1_RigidWaitsShift_IP1neg |
    |        |       | LHCBEAM/MD_ATS_2022_05_04_B2_RigidWaitsShift_IP1pos |
    |        |  IP5  | LHCBEAM/MD_ATS_2022_05_04_B1_RigidWaitsShift_IP5neg |
    |        |       | LHCBEAM/MD_ATS_2022_05_04_B1_RigidWaitsShift_IP5pos |
    | Beam 2 |  IP1  | LHCBEAM/MD_ATS_2022_05_04_B2_RigidWaitsShift_IP1neg |
    |        |       | LHCBEAM/MD_ATS_2022_05_04_B2_RigidWaitsShift_IP1pos |
    |        |  IP5  | LHCBEAM/MD_ATS_2022_05_04_B2_RigidWaitsShift_IP5neg |
    |        |       | LHCBEAM/MD_ATS_2022_05_04_B2_RigidWaitsShift_IP5pos |

!!! warning "Value of the Waist Shift"
      The waist shift from the generated knobs should be of about 43 to 44cm in either direction.
      In operation in the machine, it is likely that the optics aren't perfect and already present a small waist shift, which would add on top of the one generated by these knobs.
      This means one should expect the waists left and right to be slightly un-symmetric.

## Preliminary Setup

- [ ] <details class="nodeco"><summary>Do Global Corrections</summary>
      <p> This procedure needs global corrections to be trimmed in the machine first, so optics and *global coupling* should be taken care of beforehand.
      </p></details>

- [ ] <details class="nodeco"><summary>**Optional:** Scan the Colinearity Knob to Check Conditions</summary>
      <p> If time allows, ideally we would scan the colinearity knob to ensure we see very small variations of the $|C^{-}|$.
      If strong variations are noticed, then the expected conditions for the procedure are not met: either the phase advance between left and right MQSXs is off, or the $\sqrt{\beta_x \beta_y}$ is significantly wrong at these elements.
      </p></details>

## Procedure Per IP

This procedure is applied at the main experimental insertions (IR1 and IR5) where local corrections need to be established or checked.
Keep in mind that this does Beam1 and Beam2 at the same time, but different IPs cannot / should not be done in parallel.

!!! warning "Orbit & Tune Feedbacks"
      These feedbacks should be kept **ON** during the trim of the knobs and the procedure.

- [ ] <details class="nodeco"><summary>Trim in the Waist Shift Knob</summary>
      <p> Trim the prepared knob in the machine, for a certain direction (waist left/right of the IP).
      Remember that this affects both beams at the same time.
      </p></details>

- [ ] <details class="nodeco"><summary>Scan the Colinearity Knob</summary>
      <p> Trim the colinearity knob, about half a unit at a time.
      For each setting, do some kicks and measure the $|C^{-}|$.
      </p></details>

- [ ] <details class="nodeco"><summary>Go Back to Nominal Machine</summary>
      <p> Trim out the rigid waist shift, and ensure that no drift from nominal is observed.
      If needed, do another round of global corrections.
      </p></details>

- [ ] <details class="nodeco"><summary>Trim in the Opposite Waist Shift Knob</summary>
      <p> Trim the prepared knob in the machine, for the other direction (waist right/left of the IP).
      </p></details>

- [ ] <details class="nodeco"><summary>Scan the Colinearity Knob</summary>
      <p> Trim the colinearity knob, about half a unit at a time.
      For each setting, do some kicks and measure the $|C^{-}|$.
      </p></details>

- [ ] <details class="nodeco"><summary>Determine the Correction</summary>
      <p> Plot the evolution of the $|C^{-}|$ against the setting of the colinearity knob, and pick the setting that minimizes it.
      The curves for each beam might not be minimized exactly around the same point, and a compromise may be needed.
      Eventually do a fit of the data to get a more accurate estimate of the correction.
      </p></details>

- [ ] <details class="nodeco"><summary>**Optional:** Perform a Luminosity Scan of the Colinearity Knob</summary>
      <p> In commissioning and if conditions allow, one can validate and fine tune the correction with a luminosity scan.
      This has to be performed without a rigid waist shift.
      </p></details>

- [ ] <details class="nodeco"><summary>**Optional:** Do Global Corrections After Trimming</summary>
      <p> One might want to do another round of global corrections, mainly coupling, after applying the determined colinearity knob setting.
      </p></details>

[^SoubeletIPACLocalCouplingCorrection]:
    ??? abstract "Prospect for Interaction Region Local Coupling Correction in the LHC Run 3, `F. Soubelet, and T. Persson, and R. Tomás, and O. Apsimon, and C.P. Welsch`, [International Particle Accelerator Conference, 2021](https://accelconf.web.cern.ch/ipac2021/papers/mopab007.pdf){target=_blank}"
        ```
        @inproceedings{soubeletProspectInteractionRegion2021,  
          author={Soubelet, F. and Persson, T. and Tomás, R. and Apsimon, O. and Welsch, C.P.},
          booktitle={Proceedings of the 12th International Particle Accelerator Conference},
          title={Prospect for Interaction Region Local Coupling Correction in the LHC Run 3},
          year={2021},
          url={https://accelconf.web.cern.ch/ipac2021/papers/mopab007.pdf},
          doi={10.18429/JACOW-IPAC2021-MOPAB007}
        }
        ```

*[rigid waist shift]: Shifting the waist of the beam from the IP point by un-balancing the powering of the left and right triplets in the IR.
*[MQSX]: The skew quadrupole correctors localed next to Q3
*[LSA]: LHC Software Architecture
*[IP]: Interaction Point
*[IR]: Insertion Region
*[RDT]: Resonance Driving Terms
*[Colinearity Knob]: This is a powering setting of the MQSXs, which corresponds to a K1S value of +/- 1E-4 m^-2.

[rws_gallery]: https://fsoubelet.github.io/PyhDToolkit/gallery/demo_lhc_rigid_waist_shift.html
[logbook_entry]: https://be-op-logbook.web.cern.ch/elogbook-server/GET/showEventInLogbook/3545713